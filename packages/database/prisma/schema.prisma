// zigznote Database Schema
// AI Meeting Assistant - Production Ready

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["fullTextSearch", "fullTextIndex"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// Enums
// ============================================

enum AccountType {
  REGULAR        // Normal paying customer
  TRIAL          // Trial period
  COMPLIMENTARY  // Free account (admin override)
  PARTNER        // Partner account with special terms
  INTERNAL       // Internal team account
}

// ============================================
// Users and Organizations
// ============================================

model Organization {
  id        String    @id @default(uuid())
  name      String
  clerkId   String?   @unique @map("clerk_id")
  plan      String    @default("free") // free, pro, enterprise
  settings  Json      @default("{}")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Account type and billing overrides (admin-managed)
  accountType           AccountType @default(REGULAR) @map("account_type")
  billingOverrideReason String?     @map("billing_override_reason")   // Why is this account special?
  billingOverrideBy     String?     @map("billing_override_by")       // Admin ID who set the override
  billingOverrideAt     DateTime?   @map("billing_override_at")       // When override was set
  accountNotes          String?     @map("account_notes")             // Internal notes for support

  // Phase 8.95: Plan downgrade violations
  planViolations    Json?     @map("plan_violations")      // Array of PlanViolation objects
  planViolationsAt  DateTime? @map("plan_violations_at")   // When violations were detected

  users                  User[]
  meetings               Meeting[]
  integrationConnections IntegrationConnection[]
  automationRules        AutomationRule[]
  webhooks               Webhook[]
  billingCustomer        BillingCustomer?
  userApiKeys            UserApiKey[]
  speakerAliases         SpeakerAlias[]
  customVocabulary       CustomVocabulary[]
  voiceProfiles          VoiceProfile[]
  namePatterns           NamePattern[]
  dailyMetrics           OrgDailyMetrics[]
  userEngagements        UserEngagement[]
  meetingChats           MeetingChat[]

  // Phase 8.9: Production Readiness
  organizationSettings   OrganizationSettings?
  usageRecords           UsageRecord[]

  @@index([clerkId])
  @@index([deletedAt])
  @@index([accountType])
  @@map("organizations")
}

model User {
  id             String    @id @default(uuid())
  organizationId String    @map("organization_id")
  email          String    @unique
  name           String?
  clerkId        String?   @unique @map("clerk_id")
  role           String    @default("member") // admin, member
  avatarUrl      String?   @map("avatar_url")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")
  deletedAt      DateTime? @map("deleted_at")

  organization        Organization         @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  calendarConnections CalendarConnection[]
  meetingsCreated     Meeting[]            @relation("MeetingCreator")
  apiKeys             UserApiKey[]
  voiceProfiles       VoiceProfile[]
  engagement          UserEngagement?
  meetingChats        MeetingChat[]

  // Phase 8.9: Production Readiness
  notificationPreferences NotificationPreferences?
  dataExports             DataExport[]
  meetingShares           MeetingShare[]

  @@index([organizationId])
  @@index([clerkId])
  @@index([deletedAt])
  @@map("users")
}

// ============================================
// User API Keys
// ============================================

model UserApiKey {
  id             String    @id @default(uuid())
  userId         String    @map("user_id")
  organizationId String    @map("organization_id")

  name           String    // User-provided name: "My Zapier Key", "Mobile App"
  keyPrefix      String    @map("key_prefix") // First 12 chars for identification: "sk_live_xxxx"
  keyHash        String    @unique @map("key_hash") // bcrypt hash of full key

  // Permissions (granular scopes)
  scopes         String[]  // ["meetings:read", "meetings:write", "transcripts:read"]

  // Usage tracking
  lastUsedAt     DateTime? @map("last_used_at")
  lastUsedIp     String?   @map("last_used_ip")
  usageCount     Int       @default(0) @map("usage_count")

  // Lifecycle
  expiresAt      DateTime? @map("expires_at")
  revokedAt      DateTime? @map("revoked_at")
  createdAt      DateTime  @default(now()) @map("created_at")

  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([organizationId])
  @@index([keyPrefix])
  @@map("user_api_keys")
}

// ============================================
// Speaker Recognition
// ============================================

// Learned speaker identities for an organization
model SpeakerAlias {
  id             String   @id @default(uuid())
  organizationId String   @map("organization_id")

  // Voice identification (from Deepgram diarization)
  speakerLabel   String   @map("speaker_label") // "Speaker 0", "Speaker 1", etc.

  // User-provided identity
  displayName    String   @map("display_name")  // "John Smith"
  email          String?                         // Optional: link to known user

  // Learning context
  meetingId      String?  @map("meeting_id")    // First meeting where identified
  confidence     Float    @default(1.0)         // How confident we are in this mapping

  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  meeting        Meeting?     @relation(fields: [meetingId], references: [id], onDelete: SetNull)

  @@unique([organizationId, speakerLabel])
  @@index([organizationId])
  @@map("speaker_aliases")
}

// Custom vocabulary for improved transcription accuracy
model CustomVocabulary {
  id             String   @id @default(uuid())
  organizationId String   @map("organization_id")

  term           String   // "zigznote", "Acme Corp", "Kubernetes"
  boost          Float    @default(1.5) // How much to boost this term (1.0-2.0)
  category       String?  // "product", "company", "person", "technical"

  createdAt      DateTime @default(now()) @map("created_at")

  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, term])
  @@index([organizationId])
  @@map("custom_vocabulary")
}

// ============================================
// Voice Profiles for Speaker Recognition
// ============================================

// Stored voice profile for cross-meeting recognition
model VoiceProfile {
  id             String   @id @default(uuid())
  organizationId String   @map("organization_id")

  // Identity
  displayName    String   @map("display_name")  // "Sarah Johnson"
  email          String?                         // Link to known user if possible
  userId         String?  @map("user_id")        // Link to User if internal

  // Voice characteristics (from Deepgram or computed)
  voiceEmbedding Bytes?   @map("voice_embedding") // Binary embedding vector
  voiceHash      String?  @map("voice_hash")      // Quick comparison hash

  // Learning metadata
  sampleCount    Int      @default(1) @map("sample_count")  // How many meetings used to build profile
  totalDuration  Int      @default(0) @map("total_duration") // Total seconds of speech analyzed
  confidence     Float    @default(0.5)                      // 0-1 confidence in this profile

  // Source tracking
  firstMeetingId String?  @map("first_meeting_id")
  lastMeetingId  String?  @map("last_meeting_id")

  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User?        @relation(fields: [userId], references: [id], onDelete: SetNull)
  firstMeeting   Meeting?     @relation("FirstMeeting", fields: [firstMeetingId], references: [id], onDelete: SetNull)
  lastMeeting    Meeting?     @relation("LastMeeting", fields: [lastMeetingId], references: [id], onDelete: SetNull)
  speakerMatches SpeakerMatch[]

  @@unique([organizationId, email])
  @@index([organizationId])
  @@index([voiceHash])
  @@map("voice_profiles")
}

// Speaker match for a specific meeting
model SpeakerMatch {
  id             String   @id @default(uuid())
  meetingId      String   @map("meeting_id")
  voiceProfileId String   @map("voice_profile_id")

  // Match details
  speakerLabel   String   @map("speaker_label")  // "Speaker 0", "Speaker 1"
  matchMethod    String   @map("match_method")   // "introduction", "voice_match", "calendar", "manual"
  confidence     Float    @default(1.0)          // How confident we are in this match

  // Detection context
  detectedPhrase String?  @map("detected_phrase") // "Hi, I'm Sarah" - the phrase that identified them
  detectedAt     Float?   @map("detected_at")     // Timestamp in audio where detected

  createdAt      DateTime @default(now()) @map("created_at")

  meeting        Meeting      @relation(fields: [meetingId], references: [id], onDelete: Cascade)
  voiceProfile   VoiceProfile @relation(fields: [voiceProfileId], references: [id], onDelete: Cascade)

  @@unique([meetingId, speakerLabel])
  @@unique([meetingId, voiceProfileId])
  @@index([meetingId])
  @@map("speaker_matches")
}

// Name detection patterns (configurable per org)
model NamePattern {
  id             String   @id @default(uuid())
  organizationId String?  @map("organization_id") // null = global pattern

  pattern        String   // Regex pattern
  nameGroup      Int      @default(1) @map("name_group") // Capture group for name
  priority       Int      @default(0) // Higher = checked first
  isActive       Boolean  @default(true) @map("is_active")

  createdAt      DateTime @default(now()) @map("created_at")

  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@map("name_patterns")
}

// ============================================
// Calendar Integration
// ============================================

model CalendarConnection {
  id            String    @id @default(uuid())
  userId        String    @map("user_id")
  provider      String // google, microsoft
  accessToken   String?   @map("access_token")
  refreshToken  String?   @map("refresh_token")
  tokenExpires  DateTime? @map("token_expires_at")
  calendarId    String?   @map("calendar_id")
  syncEnabled   Boolean   @default(true) @map("sync_enabled")
  lastSyncedAt  DateTime? @map("last_synced_at")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, provider])
  @@map("calendar_connections")
}

// ============================================
// Meetings
// ============================================

model Meeting {
  id              String    @id @default(uuid())
  organizationId  String    @map("organization_id")
  createdById     String?   @map("created_by")
  title           String
  platform        String? // zoom, meet, teams, webex, other
  meetingUrl      String?   @map("meeting_url")
  recordingUrl    String?   @map("recording_url")
  startTime       DateTime? @map("start_time")
  endTime         DateTime? @map("end_time")
  durationSeconds Int?      @map("duration_seconds")
  status          String    @default("scheduled") // scheduled, recording, processing, completed, failed
  botId           String?   @map("bot_id") // Recall.ai bot ID
  calendarEventId String?   @map("calendar_event_id")
  metadata        Json      @default("{}")

  // Audio source tracking
  // source values: "bot" (Recall.ai), "upload" (user uploaded file), "browser" (recorded via browser), "mobile" (future)
  source          String    @default("bot")
  audioFileUrl    String?   @map("audio_file_url")   // S3/storage URL for uploaded/recorded audio
  audioFileName   String?   @map("audio_file_name")  // Original filename
  audioFileSize   Int?      @map("audio_file_size")  // Size in bytes
  audioDuration   Int?      @map("audio_duration")   // Duration in seconds

  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  deletedAt       DateTime? @map("deleted_at")

  organization       Organization         @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdBy          User?                @relation("MeetingCreator", fields: [createdById], references: [id], onDelete: SetNull)
  participants       MeetingParticipant[]
  transcript         Transcript?
  summary            Summary?
  actionItems        ActionItem[]
  embeddings         TranscriptEmbedding[]
  speakerAliases     SpeakerAlias[]
  speakerMatches     SpeakerMatch[]
  voiceProfilesFirst     VoiceProfile[]       @relation("FirstMeeting")
  voiceProfilesLast      VoiceProfile[]       @relation("LastMeeting")
  analytics              MeetingAnalytics?
  chats                  MeetingChat[]
  suggestedQuestions     SuggestedQuestion[]

  // Phase 8.9: Production Readiness
  shares                 MeetingShare[]

  @@index([organizationId])
  @@index([status])
  @@index([startTime])
  @@index([createdById])
  @@index([deletedAt])
  @@index([source])
  @@map("meetings")
}

model MeetingParticipant {
  id           String  @id @default(uuid())
  meetingId    String  @map("meeting_id")
  name         String
  email        String?
  speakerLabel String? @map("speaker_label") // Speaker 1, Speaker 2, etc.
  isHost       Boolean @default(false) @map("is_host")

  meeting Meeting @relation(fields: [meetingId], references: [id], onDelete: Cascade)

  @@index([meetingId])
  @@map("meeting_participants")
}

// ============================================
// Transcripts and Content
// ============================================

model Transcript {
  id        String   @id @default(uuid())
  meetingId String   @unique @map("meeting_id")
  segments  Json // [{speaker, text, start_ms, end_ms, confidence}]
  fullText  String   @map("full_text")
  wordCount Int      @map("word_count")
  language  String   @default("en")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  meeting Meeting @relation(fields: [meetingId], references: [id], onDelete: Cascade)

  @@map("transcripts")
}

model Summary {
  id            String   @id @default(uuid())
  meetingId     String   @unique @map("meeting_id")
  content       Json // {executive_summary, topics[], decisions[], questions[]}
  modelUsed     String   @map("model_used")
  promptVersion String?  @map("prompt_version")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  meeting Meeting @relation(fields: [meetingId], references: [id], onDelete: Cascade)

  @@map("summaries")
}

model ActionItem {
  id          String    @id @default(uuid())
  meetingId   String    @map("meeting_id")
  text        String
  assignee    String?
  dueDate     DateTime? @map("due_date")
  completed   Boolean   @default(false)
  completedAt DateTime? @map("completed_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  meeting Meeting @relation(fields: [meetingId], references: [id], onDelete: Cascade)

  @@index([meetingId])
  @@index([completed])
  @@map("action_items")
}

// ============================================
// Search and Embeddings
// ============================================

model TranscriptEmbedding {
  id         String   @id @default(uuid())
  meetingId  String   @map("meeting_id")
  chunkIndex Int      @map("chunk_index")
  chunkText  String   @map("chunk_text")
  embedding  Bytes? // Vector stored as bytes (will use pgvector extension)
  createdAt  DateTime @default(now()) @map("created_at")

  meeting Meeting @relation(fields: [meetingId], references: [id], onDelete: Cascade)

  @@index([meetingId])
  @@map("transcript_embeddings")
}

// ============================================
// Integrations
// ============================================

model IntegrationConnection {
  id             String   @id @default(uuid())
  organizationId String   @map("organization_id")
  provider       String // slack, hubspot, salesforce, notion, etc.
  status         String   @default("connected") // connected, disconnected, error
  credentials    Json     @default("{}") // Encrypted tokens
  settings       Json     @default("{}")
  connectedAt    DateTime @default(now()) @map("connected_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, provider])
  @@index([status])
  @@map("integration_connections")
}

model AutomationRule {
  id             String   @id @default(uuid())
  organizationId String   @map("organization_id")
  name           String
  trigger        String // meeting.completed, summary.generated, etc.
  conditions     Json     @default("{}")
  actions        Json // [{type: 'slack.send', config: {...}}]
  enabled        Boolean  @default(true)
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([trigger])
  @@map("automation_rules")
}

// ============================================
// Webhooks
// ============================================

model Webhook {
  id              String    @id @default(uuid())
  organizationId  String    @map("organization_id")
  name            String
  url             String
  secret          String    // HMAC signing secret
  events          String[]  // ['meeting.completed', 'summary.generated']
  status          String    @default("active") // active, inactive, failed
  headers         Json      @default("{}") // Custom headers
  failureCount    Int       @default(0) @map("failure_count")
  lastTriggeredAt DateTime? @map("last_triggered_at")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  organization Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  deliveries   WebhookDelivery[]

  @@index([organizationId])
  @@index([status])
  @@map("webhooks")
}

model WebhookDelivery {
  id             String    @id @default(uuid())
  webhookId      String    @map("webhook_id")
  event          String
  payload        Json
  status         String    @default("pending") // pending, success, failed
  attempts       Int       @default(0)
  lastAttemptAt  DateTime? @map("last_attempt_at")
  responseStatus Int?      @map("response_status")
  responseBody   String?   @map("response_body")
  error          String?
  createdAt      DateTime  @default(now()) @map("created_at")

  webhook Webhook @relation(fields: [webhookId], references: [id], onDelete: Cascade)

  @@index([webhookId])
  @@index([status])
  @@index([createdAt])
  @@map("webhook_deliveries")
}

// ============================================
// Billing
// ============================================

model BillingCustomer {
  id                String    @id @default(uuid())
  organizationId    String    @unique @map("organization_id")
  stripeCustomerId  String?   @unique @map("stripe_customer_id")
  flutterwaveId     String?   @unique @map("flutterwave_id")
  email             String
  name              String?
  defaultProvider   String    @default("stripe") @map("default_provider") // stripe, flutterwave
  metadata          Json      @default("{}")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  organization  Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  subscriptions Subscription[]
  payments      Payment[]
  invoices      Invoice[]

  @@index([stripeCustomerId])
  @@index([flutterwaveId])
  @@map("billing_customers")
}

model BillingPlan {
  id              String   @id @default(uuid())
  name            String
  slug            String   @unique // free, pro, enterprise
  description     String?
  amount          Int      // Amount in cents
  currency        String   @default("usd")
  interval        String   // month, year
  trialDays       Int      @default(0) @map("trial_days")
  features        Json     @default("[]") // Array of feature strings
  limits          Json     @default("{}") // {meetings_per_month, storage_gb, etc}
  stripePriceId   String?  @map("stripe_price_id")
  flutterwavePlan String?  @map("flutterwave_plan_id")
  isActive        Boolean  @default(true) @map("is_active")
  sortOrder       Int      @default(0) @map("sort_order")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  subscriptions Subscription[]

  @@index([isActive])
  @@index([slug])
  @@map("billing_plans")
}

model Subscription {
  id                 String    @id @default(uuid())
  customerId         String    @map("customer_id")
  planId             String    @map("plan_id")
  provider           String    // stripe, flutterwave
  providerSubId      String?   @map("provider_subscription_id")
  status             String    @default("active") // active, past_due, cancelled, incomplete, trialing, paused, suspended
  currentPeriodStart DateTime  @map("current_period_start")
  currentPeriodEnd   DateTime  @map("current_period_end")
  cancelAtPeriodEnd  Boolean   @default(false) @map("cancel_at_period_end")
  cancelledAt        DateTime? @map("cancelled_at")
  trialEnd           DateTime? @map("trial_end")
  metadata           Json      @default("{}")
  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")

  // Phase 8.95: Payment grace period
  graceEndsAt       DateTime? @map("grace_ends_at")
  paymentFailedAt   DateTime? @map("payment_failed_at")
  paymentRetryCount Int       @default(0) @map("payment_retry_count")

  customer BillingCustomer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  plan     BillingPlan     @relation(fields: [planId], references: [id])

  @@index([customerId])
  @@index([planId])
  @@index([status])
  @@index([providerSubId])
  @@index([graceEndsAt])
  @@map("subscriptions")
}

model Payment {
  id               String   @id @default(uuid())
  customerId       String   @map("customer_id")
  provider         String   // stripe, flutterwave
  providerPayId    String?  @map("provider_payment_id")
  amount           Int      // Amount in cents
  currency         String   @default("usd")
  status           String   @default("pending") // pending, processing, succeeded, failed, cancelled, refunded
  description      String?
  receiptUrl       String?  @map("receipt_url")
  invoiceId        String?  @map("invoice_id")
  subscriptionId   String?  @map("subscription_id")
  refundedAmount   Int      @default(0) @map("refunded_amount")
  metadata         Json     @default("{}")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  customer BillingCustomer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  invoice  Invoice?        @relation(fields: [invoiceId], references: [id])
  refunds  Refund[]

  @@index([customerId])
  @@index([status])
  @@index([providerPayId])
  @@index([invoiceId])
  @@map("payments")
}

model Invoice {
  id              String    @id @default(uuid())
  customerId      String    @map("customer_id")
  provider        String    // stripe, flutterwave
  providerInvId   String?   @map("provider_invoice_id")
  subscriptionId  String?   @map("subscription_id")
  amount          Int       // Total amount in cents
  amountPaid      Int       @default(0) @map("amount_paid")
  currency        String    @default("usd")
  status          String    @default("draft") // draft, open, paid, void, uncollectible
  dueDate         DateTime? @map("due_date")
  paidAt          DateTime? @map("paid_at")
  invoiceUrl      String?   @map("invoice_url")
  invoicePdf      String?   @map("invoice_pdf")
  lineItems       Json      @default("[]") // [{description, amount, quantity}]
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  customer BillingCustomer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  payments Payment[]

  @@index([customerId])
  @@index([status])
  @@index([providerInvId])
  @@map("invoices")
}

model Refund {
  id              String   @id @default(uuid())
  paymentId       String   @map("payment_id")
  provider        String   // stripe, flutterwave
  providerRefId   String?  @map("provider_refund_id")
  amount          Int      // Amount in cents
  currency        String   @default("usd")
  status          String   @default("pending") // pending, succeeded, failed
  reason          String?
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  payment Payment @relation(fields: [paymentId], references: [id], onDelete: Cascade)

  @@index([paymentId])
  @@index([status])
  @@map("refunds")
}

// ============================================
// Admin Panel
// ============================================

model AdminUser {
  id              String    @id @default(uuid())
  email           String    @unique
  passwordHash    String    @map("password_hash")
  name            String
  role            String    @default("support") // super_admin, admin, support, viewer

  // 2FA (TOTP)
  twoFactorSecret String?   @map("two_factor_secret")  // Encrypted TOTP secret
  twoFactorEnabled Boolean  @default(false) @map("two_factor_enabled")
  backupCodes     String[]  @map("backup_codes")       // Encrypted backup codes

  // Security
  failedLoginAttempts Int       @default(0) @map("failed_login_attempts")
  lockedUntil         DateTime? @map("locked_until")
  lastLoginAt         DateTime? @map("last_login_at")
  lastLoginIp         String?   @map("last_login_ip")
  passwordChangedAt   DateTime  @default(now()) @map("password_changed_at")

  // Lifecycle
  isActive  Boolean   @default(true) @map("is_active")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  createdBy String?   @map("created_by") // Admin who created this account

  sessions  AdminSession[]
  auditLogs AuditLog[]

  @@index([email])
  @@index([role])
  @@index([isActive])
  @@map("admin_users")
}

model AdminSession {
  id           String   @id @default(uuid())
  adminUserId  String   @map("admin_user_id")
  token        String   @unique  // JWT or session token (hashed)
  ipAddress    String   @map("ip_address")
  userAgent    String   @map("user_agent")
  expiresAt    DateTime @map("expires_at")
  lastActiveAt DateTime @default(now()) @map("last_active_at")
  createdAt    DateTime @default(now()) @map("created_at")

  adminUser AdminUser @relation(fields: [adminUserId], references: [id], onDelete: Cascade)

  @@index([adminUserId])
  @@index([token])
  @@index([expiresAt])
  @@map("admin_sessions")
}

model AuditLog {
  id           String   @id @default(uuid())
  adminUserId  String?  @map("admin_user_id")  // Null for system actions
  action       String   // user.create, org.delete, apikey.revoke, config.update, etc.
  entityType   String   @map("entity_type")    // user, organization, apikey, config, etc.
  entityId     String?  @map("entity_id")      // ID of affected entity
  details      Json     @default("{}")         // Full details of the action
  previousData Json?    @map("previous_data")  // State before change
  newData      Json?    @map("new_data")       // State after change
  ipAddress    String   @map("ip_address")
  userAgent    String?  @map("user_agent")
  createdAt    DateTime @default(now()) @map("created_at")

  adminUser AdminUser? @relation(fields: [adminUserId], references: [id], onDelete: SetNull)

  @@index([adminUserId])
  @@index([action])
  @@index([entityType])
  @@index([entityId])
  @@index([createdAt])
  @@map("audit_logs")
}

model SystemApiKey {
  id             String    @id @default(uuid())
  name           String    // Descriptive name: "Production Deepgram", "Dev Anthropic"
  provider       String    // deepgram, anthropic, openai, recall, stripe, etc.
  environment    String    @default("production") // production, staging, development

  // Encrypted key storage (AES-256)
  encryptedKey   String    @map("encrypted_key")
  keyHint        String    @map("key_hint")        // Last 4 chars for identification

  // Usage tracking
  lastUsedAt     DateTime? @map("last_used_at")
  usageCount     Int       @default(0) @map("usage_count")

  // Lifecycle
  isActive       Boolean   @default(true) @map("is_active")
  expiresAt      DateTime? @map("expires_at")
  rotatedAt      DateTime? @map("rotated_at")      // Last rotation date
  rotationDue    DateTime? @map("rotation_due")    // When to rotate next

  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")
  createdBy      String?   @map("created_by")      // Admin who created

  @@unique([provider, environment])
  @@index([provider])
  @@index([environment])
  @@index([isActive])
  @@map("system_api_keys")
}

model FeatureFlag {
  id           String    @id @default(uuid())
  key          String    @unique                  // new_dashboard, beta_search, etc.
  name         String                              // Human-readable name
  description  String?

  // Flag configuration
  enabled      Boolean   @default(false)
  percentage   Int       @default(100)            // Rollout percentage (0-100)
  targetRules  Json      @default("[]")           // [{type: 'org', ids: [...]}, {type: 'plan', value: 'enterprise'}]

  // Metadata
  category     String    @default("general")      // general, billing, ui, integrations
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")
  createdBy    String?   @map("created_by")

  @@index([key])
  @@index([enabled])
  @@index([category])
  @@map("feature_flags")
}

model SystemConfig {
  id        String   @id @default(uuid())
  key       String   @unique                     // rate_limit.api, smtp.host, etc.
  value     Json                                  // Flexible value storage
  encrypted Boolean  @default(false)             // Is the value encrypted?
  category  String   @default("general")         // general, email, limits, security

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  updatedBy String?  @map("updated_by")

  @@index([key])
  @@index([category])
  @@map("system_configs")
}

// ============================================
// AI Meeting Assistant (Q&A Conversations)
// ============================================

model Conversation {
  id             String   @id @default(uuid())
  meetingId      String   @map("meeting_id")
  userId         String   @map("user_id")
  organizationId String   @map("organization_id")

  title          String?  // Auto-generated from first question

  // Token usage tracking
  totalTokens    Int      @default(0) @map("total_tokens")

  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  messages ConversationMessage[]

  @@index([meetingId])
  @@index([userId])
  @@index([organizationId])
  @@index([createdAt])
  @@map("conversations")
}

model ConversationMessage {
  id             String   @id @default(uuid())
  conversationId String   @map("conversation_id")

  role           String   // 'user' | 'assistant'
  content        String   @db.Text

  // Metadata
  tokensUsed     Int?     @map("tokens_used")
  modelUsed      String?  @map("model_used")
  latencyMs      Int?     @map("latency_ms")

  // Source references (for grounding answers)
  sources        Json?    @default("[]") // [{segmentIndex, text, relevance}]

  createdAt      DateTime @default(now()) @map("created_at")

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([createdAt])
  @@map("conversation_messages")
}

// ============================================
// Analytics & Engagement
// ============================================

// Daily aggregated metrics per user
model UserDailyMetrics {
  id             String   @id @default(uuid())
  userId         String   @map("user_id")
  organizationId String   @map("organization_id")
  date           DateTime @db.Date

  // Meeting metrics
  meetingsRecorded    Int @default(0) @map("meetings_recorded")
  meetingsFromBot     Int @default(0) @map("meetings_from_bot")
  meetingsFromUpload  Int @default(0) @map("meetings_from_upload")
  meetingsFromBrowser Int @default(0) @map("meetings_from_browser")

  // Time metrics (in seconds)
  totalMeetingDuration Int @default(0) @map("total_meeting_duration")
  totalSpeakingTime    Int @default(0) @map("total_speaking_time")

  // Productivity metrics
  actionItemsCreated   Int @default(0) @map("action_items_created")
  actionItemsCompleted Int @default(0) @map("action_items_completed")

  // Engagement metrics
  summariesViewed   Int @default(0) @map("summaries_viewed")
  transcriptsViewed Int @default(0) @map("transcripts_viewed")
  searchesPerformed Int @default(0) @map("searches_performed")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([userId, date])
  @@index([organizationId, date])
  @@index([date])
  @@map("user_daily_metrics")
}

// Organization-level daily metrics
model OrgDailyMetrics {
  id             String   @id @default(uuid())
  organizationId String   @map("organization_id")
  date           DateTime @db.Date

  // Meeting metrics
  totalMeetings       Int @default(0) @map("total_meetings")
  meetingsFromBot     Int @default(0) @map("meetings_from_bot")
  meetingsFromUpload  Int @default(0) @map("meetings_from_upload")
  meetingsFromBrowser Int @default(0) @map("meetings_from_browser")

  // User engagement
  activeUsers Int @default(0) @map("active_users")
  newUsers    Int @default(0) @map("new_users")

  // Usage metrics
  totalMeetingMinutes Int @default(0) @map("total_meeting_minutes")
  apiKeyRequests      Int @default(0) @map("api_key_requests")
  webhookDeliveries   Int @default(0) @map("webhook_deliveries")

  // Cost tracking (in cents)
  transcriptionCost Int @default(0) @map("transcription_cost")
  summarizationCost Int @default(0) @map("summarization_cost")
  storageCost       Int @default(0) @map("storage_cost")

  createdAt DateTime @default(now()) @map("created_at")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, date])
  @@index([date])
  @@map("org_daily_metrics")
}

// User engagement tracking for retention
model UserEngagement {
  id             String    @id @default(uuid())
  userId         String    @unique @map("user_id")
  organizationId String    @map("organization_id")

  // Streaks
  currentStreak  Int       @default(0) @map("current_streak") // Days in a row with activity
  longestStreak  Int       @default(0) @map("longest_streak")
  lastActiveDate DateTime? @map("last_active_date")

  // Milestones
  totalMeetings    Int   @default(0) @map("total_meetings")
  totalActionItems Int   @default(0) @map("total_action_items")
  totalHoursSaved  Float @default(0) @map("total_hours_saved") // Estimated time saved

  // Onboarding
  onboardingCompleted Boolean @default(false) @map("onboarding_completed")
  onboardingStep      Int     @default(0) @map("onboarding_step")

  // Notifications
  weeklyDigestEnabled  Boolean   @default(true) @map("weekly_digest_enabled")
  lastDigestSentAt     DateTime? @map("last_digest_sent_at")
  inactivityReminderAt DateTime? @map("inactivity_reminder_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user         User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  achievements UserAchievement[]

  @@index([organizationId])
  @@index([lastActiveDate])
  @@map("user_engagement")
}

// Achievements/badges for gamification
model Achievement {
  id          String @id @default(uuid())
  code        String @unique // "first_meeting", "streak_7", "power_user"
  name        String // "First Meeting"
  description String // "Record your first meeting"
  icon        String // Emoji or icon name
  category    String // "onboarding", "streak", "milestone", "power_user"
  threshold   Int    @default(1) // Value needed to unlock
  points      Int    @default(10) // Gamification points

  createdAt DateTime @default(now()) @map("created_at")

  userAchievements UserAchievement[]

  @@map("achievements")
}

model UserAchievement {
  id            String   @id @default(uuid())
  userId        String   @map("user_id")
  achievementId String   @map("achievement_id")
  unlockedAt    DateTime @default(now()) @map("unlocked_at")

  engagement  UserEngagement @relation(fields: [userId], references: [userId], onDelete: Cascade)
  achievement Achievement    @relation(fields: [achievementId], references: [id], onDelete: Cascade)

  @@unique([userId, achievementId])
  @@map("user_achievements")
}

// Meeting-level analytics (for detailed insights)
model MeetingAnalytics {
  id        String @id @default(uuid())
  meetingId String @unique @map("meeting_id")

  // Participation
  participantCount Int @default(0) @map("participant_count")
  speakerCount     Int @default(0) @map("speaker_count")

  // Speaking distribution (JSON: { "Speaker 0": 45.2, "Speaker 1": 32.1, ... })
  speakingDistribution Json? @map("speaking_distribution")

  // Sentiment (from AI analysis)
  overallSentiment String? @map("overall_sentiment") // "positive", "neutral", "negative"
  sentimentScore   Float?  @map("sentiment_score") // -1.0 to 1.0

  // Efficiency metrics
  actionItemsPerMinute Float? @map("action_items_per_minute")
  decisionsCount       Int    @default(0) @map("decisions_count")
  questionsCount       Int    @default(0) @map("questions_count")

  // Topics (from AI extraction)
  topicsDiscussed Json? @map("topics_discussed") // ["budget", "timeline", "hiring"]

  // Quality indicators
  transcriptConfidence Float? @map("transcript_confidence") // Average confidence

  createdAt DateTime @default(now()) @map("created_at")

  meeting Meeting @relation(fields: [meetingId], references: [id], onDelete: Cascade)

  @@map("meeting_analytics")
}

// ============================================
// Production Readiness (Phase 8.9)
// ============================================

// User notification preferences
model NotificationPreferences {
  id             String   @id @default(uuid())
  userId         String   @unique @map("user_id")

  // Email notifications
  emailMeetingReady       Boolean @default(true) @map("email_meeting_ready")
  emailActionItemReminder Boolean @default(true) @map("email_action_item_reminder")
  emailWeeklyDigest       Boolean @default(true) @map("email_weekly_digest")
  emailMeetingShared      Boolean @default(true) @map("email_meeting_shared")
  emailPaymentAlerts      Boolean @default(true) @map("email_payment_alerts")

  // Reminder timing
  actionItemReminderDays  Int     @default(1) @map("action_item_reminder_days") // Days before due

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notification_preferences")
}

// Organization-wide settings
model OrganizationSettings {
  id             String   @id @default(uuid())
  organizationId String   @unique @map("organization_id")

  // Recording consent
  recordingConsentEnabled  Boolean @default(true) @map("recording_consent_enabled")
  consentAnnouncementText  String? @map("consent_announcement_text")
  requireExplicitConsent   Boolean @default(false) @map("require_explicit_consent")

  // Bot settings
  defaultBotName           String  @default("zigznote Notetaker") @map("default_bot_name")
  joinAnnouncementEnabled  Boolean @default(true) @map("join_announcement_enabled")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("organization_settings")
}

// GDPR Data Export requests
model DataExport {
  id             String    @id @default(uuid())
  userId         String    @map("user_id")
  organizationId String    @map("organization_id")

  status         String    @default("pending") // pending, processing, completed, failed, expired
  includeAudio   Boolean   @default(false) @map("include_audio")
  downloadUrl    String?   @map("download_url")
  expiresAt      DateTime? @map("expires_at")
  sizeBytes      Int?      @map("size_bytes")
  errorMessage   String?   @map("error_message")

  createdAt      DateTime  @default(now()) @map("created_at")
  completedAt    DateTime? @map("completed_at")

  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@map("data_exports")
}

// Meeting sharing
model MeetingShare {
  id             String    @id @default(uuid())
  meetingId      String    @map("meeting_id")
  sharedById     String    @map("shared_by_id")

  // Share type
  shareType      String    @map("share_type") // "link" | "email" | "team"
  accessLevel    String    @map("access_level") // "view" | "comment" | "edit"

  // Recipient (for email shares)
  recipientEmail String?   @map("recipient_email")
  recipientName  String?   @map("recipient_name")

  // Link sharing
  shareToken     String?   @unique @map("share_token")
  password       String?   // Optional password protection

  // Access limits
  expiresAt      DateTime? @map("expires_at")
  maxViews       Int?      @map("max_views")
  viewCount      Int       @default(0) @map("view_count")

  // Content permissions
  includeTranscript  Boolean @default(true) @map("include_transcript")
  includeSummary     Boolean @default(true) @map("include_summary")
  includeActionItems Boolean @default(true) @map("include_action_items")
  includeRecording   Boolean @default(false) @map("include_recording")

  // Message
  message        String?

  // Lifecycle
  createdAt      DateTime  @default(now()) @map("created_at")
  lastAccessedAt DateTime? @map("last_accessed_at")
  revokedAt      DateTime? @map("revoked_at")

  meeting        Meeting   @relation(fields: [meetingId], references: [id], onDelete: Cascade)
  sharedBy       User      @relation(fields: [sharedById], references: [id])

  @@index([meetingId])
  @@index([shareToken])
  @@index([sharedById])
  @@map("meeting_shares")
}

// Usage tracking for quota enforcement
model UsageRecord {
  id             String   @id @default(uuid())
  organizationId String   @map("organization_id")
  period         String   // "2024-01" format for monthly billing cycles

  // Meetings
  meetingsCount      Int @default(0) @map("meetings_count")
  meetingMinutes     Int @default(0) @map("meeting_minutes")

  // Storage (in bytes)
  storageUsed        BigInt @default(0) @map("storage_used")
  audioStorageUsed   BigInt @default(0) @map("audio_storage_used")

  // AI usage
  transcriptionMinutes Int @default(0) @map("transcription_minutes")
  summarizationTokens  Int @default(0) @map("summarization_tokens")
  chatTokens           Int @default(0) @map("chat_tokens")

  // API usage
  apiRequests        Int @default(0) @map("api_requests")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, period])
  @@index([organizationId])
  @@index([period])
  @@map("usage_records")
}

// ============================================
// Meeting AI Chat (Cross-Meeting Support)
// ============================================

// Chat conversation per meeting (or cross-meeting)
model MeetingChat {
  id             String   @id @default(uuid())
  organizationId String   @map("organization_id")
  userId         String   @map("user_id")
  meetingId      String?  @map("meeting_id") // null = cross-meeting chat
  title          String?  // Auto-generated or user-set
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  organization Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  meeting      Meeting?      @relation(fields: [meetingId], references: [id], onDelete: Cascade)
  messages     ChatMessage[]

  @@index([organizationId])
  @@index([userId])
  @@index([meetingId])
  @@map("meeting_chats")
}

// Individual chat messages
model ChatMessage {
  id        String   @id @default(uuid())
  chatId    String   @map("chat_id")
  role      String   // "user" | "assistant"
  content   String   @db.Text

  // Source citations (for assistant messages)
  citations Json?    // [{meetingId, timestamp, text, relevance}]

  // Metadata
  model     String?  // "claude-3.5-sonnet" | "gpt-4o"
  tokens    Int?     // Token count for billing tracking
  latencyMs Int?     @map("latency_ms")

  createdAt DateTime @default(now()) @map("created_at")

  chat MeetingChat @relation(fields: [chatId], references: [id], onDelete: Cascade)

  @@index([chatId])
  @@index([createdAt])
  @@map("chat_messages")
}

// Suggested questions per meeting (auto-generated)
model SuggestedQuestion {
  id        String   @id @default(uuid())
  meetingId String   @map("meeting_id")
  question  String
  category  String   // "decisions", "action_items", "key_points", "follow_up"
  priority  Int      @default(0)
  createdAt DateTime @default(now()) @map("created_at")

  meeting Meeting @relation(fields: [meetingId], references: [id], onDelete: Cascade)

  @@index([meetingId])
  @@map("suggested_questions")
}

// ============================================
// Phase 8.95: Critical Infrastructure Fixes
// ============================================

// Webhook idempotency tracking
model ProcessedWebhook {
  id          String   @id @default(uuid())
  provider    String   // 'recall' | 'clerk' | 'stripe' | 'deepgram' | 'flutterwave'
  eventId     String   @map("event_id")
  eventType   String   @map("event_type")
  processedAt DateTime @default(now()) @map("processed_at")

  @@unique([provider, eventId])
  @@index([processedAt])
  @@map("processed_webhooks")
}

// ============================================
// Backup & Recovery (Phase 10.1)
// ============================================

enum BackupType {
  FULL
  INCREMENTAL
  SCHEDULED
  MANUAL
  PRE_MIGRATION
}

enum BackupStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  FAILED
  EXPIRED
  DELETED
}

model DatabaseBackup {
  id            String       @id @default(uuid())
  filename      String       @unique
  size          BigInt       // Size in bytes
  type          BackupType
  status        BackupStatus @default(PENDING)
  storageUrl    String?      @map("storage_url")
  checksum      String?      // SHA-256 hash
  metadata      Json?
  startedAt     DateTime     @default(now()) @map("started_at")
  completedAt   DateTime?    @map("completed_at")
  expiresAt     DateTime?    @map("expires_at")
  createdById   String?      @map("created_by_id")
  errorMessage  String?      @map("error_message")

  @@index([status])
  @@index([type])
  @@index([createdById])
  @@index([expiresAt])
  @@map("database_backups")
}
