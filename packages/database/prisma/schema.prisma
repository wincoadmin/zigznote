// zigznote Database Schema
// AI Meeting Assistant - Production Ready

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["fullTextSearch", "fullTextIndex"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// Users and Organizations
// ============================================

model Organization {
  id        String    @id @default(uuid())
  name      String
  clerkId   String?   @unique @map("clerk_id")
  plan      String    @default("free") // free, pro, enterprise
  settings  Json      @default("{}")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  users                  User[]
  meetings               Meeting[]
  integrationConnections IntegrationConnection[]
  automationRules        AutomationRule[]
  webhooks               Webhook[]
  billingCustomer        BillingCustomer?
  userApiKeys            UserApiKey[]
  speakerAliases         SpeakerAlias[]
  customVocabulary       CustomVocabulary[]
  voiceProfiles          VoiceProfile[]
  namePatterns           NamePattern[]

  @@index([clerkId])
  @@index([deletedAt])
  @@map("organizations")
}

model User {
  id             String    @id @default(uuid())
  organizationId String    @map("organization_id")
  email          String    @unique
  name           String?
  clerkId        String?   @unique @map("clerk_id")
  role           String    @default("member") // admin, member
  avatarUrl      String?   @map("avatar_url")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")
  deletedAt      DateTime? @map("deleted_at")

  organization        Organization         @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  calendarConnections CalendarConnection[]
  meetingsCreated     Meeting[]            @relation("MeetingCreator")
  apiKeys             UserApiKey[]
  voiceProfiles       VoiceProfile[]

  @@index([organizationId])
  @@index([clerkId])
  @@index([deletedAt])
  @@map("users")
}

// ============================================
// User API Keys
// ============================================

model UserApiKey {
  id             String    @id @default(uuid())
  userId         String    @map("user_id")
  organizationId String    @map("organization_id")

  name           String    // User-provided name: "My Zapier Key", "Mobile App"
  keyPrefix      String    @map("key_prefix") // First 12 chars for identification: "sk_live_xxxx"
  keyHash        String    @unique @map("key_hash") // bcrypt hash of full key

  // Permissions (granular scopes)
  scopes         String[]  // ["meetings:read", "meetings:write", "transcripts:read"]

  // Usage tracking
  lastUsedAt     DateTime? @map("last_used_at")
  lastUsedIp     String?   @map("last_used_ip")
  usageCount     Int       @default(0) @map("usage_count")

  // Lifecycle
  expiresAt      DateTime? @map("expires_at")
  revokedAt      DateTime? @map("revoked_at")
  createdAt      DateTime  @default(now()) @map("created_at")

  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([organizationId])
  @@index([keyPrefix])
  @@map("user_api_keys")
}

// ============================================
// Speaker Recognition
// ============================================

// Learned speaker identities for an organization
model SpeakerAlias {
  id             String   @id @default(uuid())
  organizationId String   @map("organization_id")

  // Voice identification (from Deepgram diarization)
  speakerLabel   String   @map("speaker_label") // "Speaker 0", "Speaker 1", etc.

  // User-provided identity
  displayName    String   @map("display_name")  // "John Smith"
  email          String?                         // Optional: link to known user

  // Learning context
  meetingId      String?  @map("meeting_id")    // First meeting where identified
  confidence     Float    @default(1.0)         // How confident we are in this mapping

  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  meeting        Meeting?     @relation(fields: [meetingId], references: [id], onDelete: SetNull)

  @@unique([organizationId, speakerLabel])
  @@index([organizationId])
  @@map("speaker_aliases")
}

// Custom vocabulary for improved transcription accuracy
model CustomVocabulary {
  id             String   @id @default(uuid())
  organizationId String   @map("organization_id")

  term           String   // "zigznote", "Acme Corp", "Kubernetes"
  boost          Float    @default(1.5) // How much to boost this term (1.0-2.0)
  category       String?  // "product", "company", "person", "technical"

  createdAt      DateTime @default(now()) @map("created_at")

  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, term])
  @@index([organizationId])
  @@map("custom_vocabulary")
}

// ============================================
// Voice Profiles for Speaker Recognition
// ============================================

// Stored voice profile for cross-meeting recognition
model VoiceProfile {
  id             String   @id @default(uuid())
  organizationId String   @map("organization_id")

  // Identity
  displayName    String   @map("display_name")  // "Sarah Johnson"
  email          String?                         // Link to known user if possible
  userId         String?  @map("user_id")        // Link to User if internal

  // Voice characteristics (from Deepgram or computed)
  voiceEmbedding Bytes?   @map("voice_embedding") // Binary embedding vector
  voiceHash      String?  @map("voice_hash")      // Quick comparison hash

  // Learning metadata
  sampleCount    Int      @default(1) @map("sample_count")  // How many meetings used to build profile
  totalDuration  Int      @default(0) @map("total_duration") // Total seconds of speech analyzed
  confidence     Float    @default(0.5)                      // 0-1 confidence in this profile

  // Source tracking
  firstMeetingId String?  @map("first_meeting_id")
  lastMeetingId  String?  @map("last_meeting_id")

  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User?        @relation(fields: [userId], references: [id], onDelete: SetNull)
  firstMeeting   Meeting?     @relation("FirstMeeting", fields: [firstMeetingId], references: [id], onDelete: SetNull)
  lastMeeting    Meeting?     @relation("LastMeeting", fields: [lastMeetingId], references: [id], onDelete: SetNull)
  speakerMatches SpeakerMatch[]

  @@unique([organizationId, email])
  @@index([organizationId])
  @@index([voiceHash])
  @@map("voice_profiles")
}

// Speaker match for a specific meeting
model SpeakerMatch {
  id             String   @id @default(uuid())
  meetingId      String   @map("meeting_id")
  voiceProfileId String   @map("voice_profile_id")

  // Match details
  speakerLabel   String   @map("speaker_label")  // "Speaker 0", "Speaker 1"
  matchMethod    String   @map("match_method")   // "introduction", "voice_match", "calendar", "manual"
  confidence     Float    @default(1.0)          // How confident we are in this match

  // Detection context
  detectedPhrase String?  @map("detected_phrase") // "Hi, I'm Sarah" - the phrase that identified them
  detectedAt     Float?   @map("detected_at")     // Timestamp in audio where detected

  createdAt      DateTime @default(now()) @map("created_at")

  meeting        Meeting      @relation(fields: [meetingId], references: [id], onDelete: Cascade)
  voiceProfile   VoiceProfile @relation(fields: [voiceProfileId], references: [id], onDelete: Cascade)

  @@unique([meetingId, speakerLabel])
  @@unique([meetingId, voiceProfileId])
  @@index([meetingId])
  @@map("speaker_matches")
}

// Name detection patterns (configurable per org)
model NamePattern {
  id             String   @id @default(uuid())
  organizationId String?  @map("organization_id") // null = global pattern

  pattern        String   // Regex pattern
  nameGroup      Int      @default(1) @map("name_group") // Capture group for name
  priority       Int      @default(0) // Higher = checked first
  isActive       Boolean  @default(true) @map("is_active")

  createdAt      DateTime @default(now()) @map("created_at")

  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@map("name_patterns")
}

// ============================================
// Calendar Integration
// ============================================

model CalendarConnection {
  id            String    @id @default(uuid())
  userId        String    @map("user_id")
  provider      String // google, microsoft
  accessToken   String?   @map("access_token")
  refreshToken  String?   @map("refresh_token")
  tokenExpires  DateTime? @map("token_expires_at")
  calendarId    String?   @map("calendar_id")
  syncEnabled   Boolean   @default(true) @map("sync_enabled")
  lastSyncedAt  DateTime? @map("last_synced_at")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, provider])
  @@map("calendar_connections")
}

// ============================================
// Meetings
// ============================================

model Meeting {
  id              String    @id @default(uuid())
  organizationId  String    @map("organization_id")
  createdById     String?   @map("created_by")
  title           String
  platform        String? // zoom, meet, teams, webex, other
  meetingUrl      String?   @map("meeting_url")
  recordingUrl    String?   @map("recording_url")
  startTime       DateTime? @map("start_time")
  endTime         DateTime? @map("end_time")
  durationSeconds Int?      @map("duration_seconds")
  status          String    @default("scheduled") // scheduled, recording, processing, completed, failed
  botId           String?   @map("bot_id") // Recall.ai bot ID
  calendarEventId String?   @map("calendar_event_id")
  metadata        Json      @default("{}")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  deletedAt       DateTime? @map("deleted_at")

  organization       Organization         @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdBy          User?                @relation("MeetingCreator", fields: [createdById], references: [id], onDelete: SetNull)
  participants       MeetingParticipant[]
  transcript         Transcript?
  summary            Summary?
  actionItems        ActionItem[]
  embeddings         TranscriptEmbedding[]
  speakerAliases     SpeakerAlias[]
  speakerMatches     SpeakerMatch[]
  voiceProfilesFirst VoiceProfile[]       @relation("FirstMeeting")
  voiceProfilesLast  VoiceProfile[]       @relation("LastMeeting")

  @@index([organizationId])
  @@index([status])
  @@index([startTime])
  @@index([createdById])
  @@index([deletedAt])
  @@map("meetings")
}

model MeetingParticipant {
  id           String  @id @default(uuid())
  meetingId    String  @map("meeting_id")
  name         String
  email        String?
  speakerLabel String? @map("speaker_label") // Speaker 1, Speaker 2, etc.
  isHost       Boolean @default(false) @map("is_host")

  meeting Meeting @relation(fields: [meetingId], references: [id], onDelete: Cascade)

  @@index([meetingId])
  @@map("meeting_participants")
}

// ============================================
// Transcripts and Content
// ============================================

model Transcript {
  id        String   @id @default(uuid())
  meetingId String   @unique @map("meeting_id")
  segments  Json // [{speaker, text, start_ms, end_ms, confidence}]
  fullText  String   @map("full_text")
  wordCount Int      @map("word_count")
  language  String   @default("en")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  meeting Meeting @relation(fields: [meetingId], references: [id], onDelete: Cascade)

  @@map("transcripts")
}

model Summary {
  id            String   @id @default(uuid())
  meetingId     String   @unique @map("meeting_id")
  content       Json // {executive_summary, topics[], decisions[], questions[]}
  modelUsed     String   @map("model_used")
  promptVersion String?  @map("prompt_version")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  meeting Meeting @relation(fields: [meetingId], references: [id], onDelete: Cascade)

  @@map("summaries")
}

model ActionItem {
  id          String    @id @default(uuid())
  meetingId   String    @map("meeting_id")
  text        String
  assignee    String?
  dueDate     DateTime? @map("due_date")
  completed   Boolean   @default(false)
  completedAt DateTime? @map("completed_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  meeting Meeting @relation(fields: [meetingId], references: [id], onDelete: Cascade)

  @@index([meetingId])
  @@index([completed])
  @@map("action_items")
}

// ============================================
// Search and Embeddings
// ============================================

model TranscriptEmbedding {
  id         String   @id @default(uuid())
  meetingId  String   @map("meeting_id")
  chunkIndex Int      @map("chunk_index")
  chunkText  String   @map("chunk_text")
  embedding  Bytes? // Vector stored as bytes (will use pgvector extension)
  createdAt  DateTime @default(now()) @map("created_at")

  meeting Meeting @relation(fields: [meetingId], references: [id], onDelete: Cascade)

  @@index([meetingId])
  @@map("transcript_embeddings")
}

// ============================================
// Integrations
// ============================================

model IntegrationConnection {
  id             String   @id @default(uuid())
  organizationId String   @map("organization_id")
  provider       String // slack, hubspot, salesforce, notion, etc.
  status         String   @default("connected") // connected, disconnected, error
  credentials    Json     @default("{}") // Encrypted tokens
  settings       Json     @default("{}")
  connectedAt    DateTime @default(now()) @map("connected_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, provider])
  @@index([status])
  @@map("integration_connections")
}

model AutomationRule {
  id             String   @id @default(uuid())
  organizationId String   @map("organization_id")
  name           String
  trigger        String // meeting.completed, summary.generated, etc.
  conditions     Json     @default("{}")
  actions        Json // [{type: 'slack.send', config: {...}}]
  enabled        Boolean  @default(true)
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([trigger])
  @@map("automation_rules")
}

// ============================================
// Webhooks
// ============================================

model Webhook {
  id              String    @id @default(uuid())
  organizationId  String    @map("organization_id")
  name            String
  url             String
  secret          String    // HMAC signing secret
  events          String[]  // ['meeting.completed', 'summary.generated']
  status          String    @default("active") // active, inactive, failed
  headers         Json      @default("{}") // Custom headers
  failureCount    Int       @default(0) @map("failure_count")
  lastTriggeredAt DateTime? @map("last_triggered_at")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  organization Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  deliveries   WebhookDelivery[]

  @@index([organizationId])
  @@index([status])
  @@map("webhooks")
}

model WebhookDelivery {
  id             String    @id @default(uuid())
  webhookId      String    @map("webhook_id")
  event          String
  payload        Json
  status         String    @default("pending") // pending, success, failed
  attempts       Int       @default(0)
  lastAttemptAt  DateTime? @map("last_attempt_at")
  responseStatus Int?      @map("response_status")
  responseBody   String?   @map("response_body")
  error          String?
  createdAt      DateTime  @default(now()) @map("created_at")

  webhook Webhook @relation(fields: [webhookId], references: [id], onDelete: Cascade)

  @@index([webhookId])
  @@index([status])
  @@index([createdAt])
  @@map("webhook_deliveries")
}

// ============================================
// Billing
// ============================================

model BillingCustomer {
  id                String    @id @default(uuid())
  organizationId    String    @unique @map("organization_id")
  stripeCustomerId  String?   @unique @map("stripe_customer_id")
  flutterwaveId     String?   @unique @map("flutterwave_id")
  email             String
  name              String?
  defaultProvider   String    @default("stripe") @map("default_provider") // stripe, flutterwave
  metadata          Json      @default("{}")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  organization  Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  subscriptions Subscription[]
  payments      Payment[]
  invoices      Invoice[]

  @@index([stripeCustomerId])
  @@index([flutterwaveId])
  @@map("billing_customers")
}

model BillingPlan {
  id              String   @id @default(uuid())
  name            String
  slug            String   @unique // free, pro, enterprise
  description     String?
  amount          Int      // Amount in cents
  currency        String   @default("usd")
  interval        String   // month, year
  trialDays       Int      @default(0) @map("trial_days")
  features        Json     @default("[]") // Array of feature strings
  limits          Json     @default("{}") // {meetings_per_month, storage_gb, etc}
  stripePriceId   String?  @map("stripe_price_id")
  flutterwavePlan String?  @map("flutterwave_plan_id")
  isActive        Boolean  @default(true) @map("is_active")
  sortOrder       Int      @default(0) @map("sort_order")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  subscriptions Subscription[]

  @@index([isActive])
  @@index([slug])
  @@map("billing_plans")
}

model Subscription {
  id                 String    @id @default(uuid())
  customerId         String    @map("customer_id")
  planId             String    @map("plan_id")
  provider           String    // stripe, flutterwave
  providerSubId      String?   @map("provider_subscription_id")
  status             String    @default("active") // active, past_due, cancelled, incomplete, trialing, paused
  currentPeriodStart DateTime  @map("current_period_start")
  currentPeriodEnd   DateTime  @map("current_period_end")
  cancelAtPeriodEnd  Boolean   @default(false) @map("cancel_at_period_end")
  cancelledAt        DateTime? @map("cancelled_at")
  trialEnd           DateTime? @map("trial_end")
  metadata           Json      @default("{}")
  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")

  customer BillingCustomer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  plan     BillingPlan     @relation(fields: [planId], references: [id])

  @@index([customerId])
  @@index([planId])
  @@index([status])
  @@index([providerSubId])
  @@map("subscriptions")
}

model Payment {
  id               String   @id @default(uuid())
  customerId       String   @map("customer_id")
  provider         String   // stripe, flutterwave
  providerPayId    String?  @map("provider_payment_id")
  amount           Int      // Amount in cents
  currency         String   @default("usd")
  status           String   @default("pending") // pending, processing, succeeded, failed, cancelled, refunded
  description      String?
  receiptUrl       String?  @map("receipt_url")
  invoiceId        String?  @map("invoice_id")
  subscriptionId   String?  @map("subscription_id")
  refundedAmount   Int      @default(0) @map("refunded_amount")
  metadata         Json     @default("{}")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  customer BillingCustomer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  invoice  Invoice?        @relation(fields: [invoiceId], references: [id])
  refunds  Refund[]

  @@index([customerId])
  @@index([status])
  @@index([providerPayId])
  @@index([invoiceId])
  @@map("payments")
}

model Invoice {
  id              String    @id @default(uuid())
  customerId      String    @map("customer_id")
  provider        String    // stripe, flutterwave
  providerInvId   String?   @map("provider_invoice_id")
  subscriptionId  String?   @map("subscription_id")
  amount          Int       // Total amount in cents
  amountPaid      Int       @default(0) @map("amount_paid")
  currency        String    @default("usd")
  status          String    @default("draft") // draft, open, paid, void, uncollectible
  dueDate         DateTime? @map("due_date")
  paidAt          DateTime? @map("paid_at")
  invoiceUrl      String?   @map("invoice_url")
  invoicePdf      String?   @map("invoice_pdf")
  lineItems       Json      @default("[]") // [{description, amount, quantity}]
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  customer BillingCustomer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  payments Payment[]

  @@index([customerId])
  @@index([status])
  @@index([providerInvId])
  @@map("invoices")
}

model Refund {
  id              String   @id @default(uuid())
  paymentId       String   @map("payment_id")
  provider        String   // stripe, flutterwave
  providerRefId   String?  @map("provider_refund_id")
  amount          Int      // Amount in cents
  currency        String   @default("usd")
  status          String   @default("pending") // pending, succeeded, failed
  reason          String?
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  payment Payment @relation(fields: [paymentId], references: [id], onDelete: Cascade)

  @@index([paymentId])
  @@index([status])
  @@map("refunds")
}
